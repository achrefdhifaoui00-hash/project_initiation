name: OWASP ZAP Baseline Scan

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  zap-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t django-sec-app:latest .

      - name: Run Django app container
        run: |
          docker run -d --name django-app -p 8000:8000 django-sec-app:latest
          sleep 10

      - name: Wait for app to be ready
        run: |
          for i in {1..20}; do
            if curl -s http://localhost:8000 > /dev/null; then
              echo "App is ready!"
              exit 0
            fi
            echo "Waiting for Django to start..."
            sleep 3
          done
          echo "App did not start in time"
          exit 1

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: "http://localhost:8000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a"
          issue_title: ""         # disable GitHub issue creation
          token: ""               # avoid needing permissions

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_report.html
